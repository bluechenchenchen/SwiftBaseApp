# iPhoneBaseApp 热更新配置指南

## 概述

本项目使用 [Inject](https://github.com/krzysztofzablocki/Inject) 方案实现 SwiftUI 应用的热更新功能。热更新可以显著提高开发效率，避免频繁的编译和重启应用，让代码修改能够实时反映在运行中的应用中。

## 技术方案

- **核心库**: [Inject](https://github.com/krzysztofzablocki/Inject) - 基于 InjectionIII 的 SwiftUI 热更新解决方案
- **底层支持**: [InjectionIII](https://github.com/johnno1962/InjectionIII) - 提供代码注入能力
- **适用框架**: SwiftUI、UIKit、AppKit

## 项目配置

### 1. 依赖管理

项目使用 Swift Package Manager 管理依赖，Inject 库通过以下方式集成：

```swift
// Package.swift
dependencies: [
    .package(url: "https://github.com/krzysztofzablocki/Inject.git", from: "1.2.4")
]
```

### 2. 应用初始化配置

在 `iPhoneBaseAppApp.swift` 中配置热更新初始化：

```swift
import SwiftUI
import Inject

#if DEBUG
import UIKit
private var loadInjection: Void = {
    #if os(macOS)
    Bundle(path: "/Applications/InjectionIII.app/Contents/Resources/macOSInjection.bundle")?.load()
    #elseif os(iOS)
    Bundle(path: "/Applications/InjectionIII.app/Contents/Resources/iOSInjection.bundle")?.load()
    #endif
}()
#endif

@main
struct iPhoneBaseAppApp: App {
    @State private var modelData = ModelData()
    @ObserveInjection var forceUpdate // 强制刷新视图状态

    init() {
        #if DEBUG
        print("---> InjectionIII 初始化")

        // 真机设备设置开发机IP
        #if !targetEnvironment(simulator)
        if let localIP = getLocalIPAddress() {
            UserDefaults.standard.set(localIP, forKey: "INJECTION_ADDRESS")
        }
        #endif

        _ = loadInjection
        #endif
    }

    var body: some Scene {
        WindowGroup {
            LandmarksContentView()
                .environment(modelData)
                .enableInjection() // App根视图标记
        }
    }
}
```

### 3. 视图级配置

在需要热更新的 SwiftUI 视图中添加配置：

```swift
import SwiftUI
import Inject

struct YourView: View {
    @ObserveInjection var inject // 注入观察器

    var body: some View {
        // 你的视图内容
        VStack {
            Text("Hello World")
        }
        .enableInjection() // 启用热更新
    }
}
```

### 4. 复杂视图更新处理

对于需要强制刷新的复杂视图，使用 UUID 绑定：

```swift
struct LandmarksContentView: View {
    @State private var selection: Tab = .featured
    @State private var refreshID = UUID() // 添加注入响应状态

    var body: some View {
        TabView(selection: $selection) {
            // 视图内容
        }
        .enableInjection()
        .onReceive(NotificationCenter.default.publisher(for: Notification.Name("INJECTION_BUNDLE_NOTIFICATION"))) { _ in
            print("🔥 接收到注入通知")
            refreshID = UUID() // 强制更新视图
        }
        .id(refreshID) // 绑定刷新ID
    }
}
```

## 开发环境配置

### 1. Xcode 项目配置

在 Xcode 项目中需要添加链接器标志：

1. 选择项目 target
2. 进入 Build Settings
3. 搜索"Other Linker Flags"
4. 在 Debug 配置中添加：`-Xlinker -interposable`

### 2. InjectionIII 应用安装

1. 下载最新版本的 [InjectionIII](https://github.com/johnno1962/InjectionIII/releases)
2. 解压并放置到 `/Applications` 目录
3. 确保 Xcode 位于默认位置：`/Applications/Xcode.app`
4. 运行 InjectionIII 应用
5. 选择当前项目的工作空间文件

### 3. 真机开发配置

对于真机开发，需要配置网络连接：

```swift
// 获取本机IP地址
func getLocalIPAddress() -> String? {
    var address: String?
    var ifaddr: UnsafeMutablePointer<ifaddrs>?

    guard getifaddrs(&ifaddr) == 0 else { return nil }
    guard let firstAddr = ifaddr else { return nil }

    for ifptr in sequence(first: firstAddr, next: { $0.pointee.ifa_next }) {
        let interface = ifptr.pointee
        let addrFamily = interface.ifa_addr.pointee.sa_family
        if addrFamily == UInt8(AF_INET) {
            let name = String(cString: interface.ifa_name)
            if name == "en0" {
                var hostname = [CChar](repeating: 0, count: Int(NI_MAXHOST))
                getnameinfo(interface.ifa_addr, socklen_t(interface.ifa_addr.pointee.sa_len),
                            &hostname, socklen_t(hostname.count),
                            nil, socklen_t(0), NI_NUMERICHOST)
                address = String(cString: hostname)
            }
        }
    }
    freeifaddrs(ifaddr)
    return address
}
```

## 使用指南

### 1. 启动热更新

1. 确保 InjectionIII 应用正在运行
2. 在 Xcode 中运行应用（Debug 模式）
3. 查看控制台输出，确认连接成功：
   ```
   💉 InjectionIII connected /path/to/your/project.xcworkspace
   💉 Watching files under /path/to/your/project
   ```

### 2. 修改代码

1. 在 SwiftUI 视图中修改代码
2. 保存文件（Cmd+S）
3. 观察应用中的实时更新

### 3. 支持的修改类型

- ✅ SwiftUI 视图结构修改
- ✅ 视图属性修改
- ✅ 样式和布局修改
- ✅ 状态变量修改
- ✅ 计算属性修改

### 4. 不支持的修改类型

- ❌ 结构体/类的初始化器修改
- ❌ 协议定义修改
- ❌ 枚举定义修改
- ❌ 全局函数修改

## 最佳实践

### 1. 视图组织

```swift
// 推荐：将复杂逻辑拆分为子视图
struct ParentView: View {
    @ObserveInjection var inject

    var body: some View {
        VStack {
            ChildView1()
            ChildView2()
        }
        .enableInjection()
    }
}

struct ChildView1: View {
    var body: some View {
        Text("Child 1")
    }
}
```

### 2. 状态管理

```swift
// 推荐：使用@State进行本地状态管理
struct MyView: View {
    @ObserveInjection var inject
    @State private var isExpanded = false

    var body: some View {
        VStack {
            Text(isExpanded ? "Expanded" : "Collapsed")
            Button("Toggle") {
                isExpanded.toggle()
            }
        }
        .enableInjection()
    }
}
```

### 3. 动画配置

可以配置注入时的动画效果：

```swift
// 在应用启动时配置
InjectConfiguration.animation = .interactiveSpring()
```

## 故障排除

### 1. 常见问题

**问题**: 热更新不工作

- 检查 InjectionIII 是否正在运行
- 确认项目配置了正确的链接器标志
- 验证 Xcode 版本和 InjectionIII 版本兼容性

**问题**: 真机热更新失败

- 确认开发机和设备在同一网络
- 检查防火墙设置
- 验证 IP 地址配置正确

**问题**: 视图更新异常

- 检查是否正确添加了`.enableInjection()`
- 确认使用了`@ObserveInjection var inject`
- 对于复杂视图，考虑使用 UUID 强制刷新

### 2. 调试技巧

1. 查看控制台输出，确认 InjectionIII 连接状态
2. 使用`print`语句验证代码是否被重新执行
3. 检查网络连接（真机开发时）

### 3. 性能优化

- 避免在热更新视图中进行大量计算
- 合理使用`@State`和`@ObservedObject`
- 及时清理不需要的观察器

## 生产环境

热更新代码在生产环境中会自动被优化掉，不会影响应用性能。所有热更新相关的代码都包含在`#if DEBUG`条件编译中，确保生产构建的纯净性。

## 参考资料

- [Inject GitHub 仓库](https://github.com/krzysztofzablocki/Inject)
- [InjectionIII GitHub 仓库](https://github.com/johnno1962/InjectionIII)
- [SwiftUI 热更新最佳实践](https://www.merowing.info/2021/01/hot-reloading-in-swiftui/)

---

_最后更新: 2025 年 1 月_
